# TODO: Project Maintenance Tasks

## Current Status

- ‚úÖ **All Tests**: 197 tests passing (183 main + 14 device)
- ‚úÖ **Quality**: RuboCop clean, coverage 87.14% line / 65.37% branch
- ‚úÖ **Infrastructure**: Executor abstraction, Template engines, Device test framework complete

---

## Test Execution

**Quick Reference**:
```bash
rake              # Default: Run all tests (183 main + 14 device)
rake test         # Run main test suite (183 tests)
rake ci           # CI checks: tests + RuboCop + coverage validation
rake dev          # Development: RuboCop auto-fix + tests + coverage
```

**Quality Metrics**:
- Tests: 197 total, all passing ‚úì
- Coverage: 87.14% line, 65.37% branch (minimum: 85%/60%)
- RuboCop: 0 violations

---

## ‚ö†Ô∏è Known Issues (Unresolved)

### [TODO-INFRASTRUCTURE-CI-WORKFLOWS] CI workflow YML files not generated by ptrk init --with-ci

**Status**: FIXED (2025-11-13, commit 4b5e696)

**Discovery**: 2025-11-13 User testing in playground/
- Command: `ptrk init test-project --with-ci`
- Expected: .github/workflows/esp32-build.yml created with CI workflow template
- Actual (before fix): .github/workflows/ directory created (empty), no YML files generated
- Impact: Users cannot set up CI/CD pipeline without manual workflow creation

**Root Cause Analysis**:
- Thor option :"with-ci" converted to different key formats in options hash
- ProjectInitializer only checked :with_ci and "with_ci" keys
- When Thor passed :"with-ci" (hyphenated symbol), option check failed

**Fix Applied** (Commit 4b5e696):
- ProjectInitializer#copy_template_files: Check 4 key formats
  - `options[:with_ci]` (underscore symbol)
  - `options["with_ci"]` (underscore string)
  - `options[:"with-ci"]` (hyphenated symbol)
  - `options["with-ci"]` (hyphenated string)
- Added test: "handles with_ci when key is symbol with hyphen"

**Verification**: Re-test required in playground/ with `ptrk init test-project --with-ci`

---

### [TODO-INFRASTRUCTURE-MRBGEM-GENERATION] ptrk init --with-mrbgem flag not processed

**Status**: FIXED (2025-11-13, commit 4b5e696)

**Discovery**: 2025-11-13 User testing in playground/
- Command: `ptrk init test-mrbgem --with-mrbgem MyGem`
- Expected: mrbgems/ directory with MyGem structure created
- Actual (before fix): Flag ignored, no mrbgem generation
- Impact: Users cannot auto-generate mrbgem templates during project initialization

**Root Cause Analysis**:
- Thor option :"with-mrbgem" converted to different key formats in options hash
- ProjectInitializer only checked :with_mrbgem and "with_mrbgem" keys
- When Thor passed :"with-mrbgem" (hyphenated symbol), option check failed

**Fix Applied** (Commit 4b5e696):
- ProjectInitializer#generate_mrbgems: Check 4 key formats
  - `options[:with_mrbgem]` (underscore symbol)
  - `options["with_mrbgem"]` (underscore string)
  - `options[:"with-mrbgem"]` (hyphenated symbol)
  - `options["with-mrbgem"]` (hyphenated string)
- Added test: "handles with_mrbgem when key is symbol with hyphen"

**Verification**: Re-test required in playground/ with `ptrk init test-project --with-mrbgem MyGem`

**Note**: Implementation (generate_single_mrbgem) was already complete; only option handling was missing

---

### [TODO-INFRASTRUCTURE-DEVICE-TEST] Thor help command breaks test-unit registration

**Status**: Omitted (low priority)

**Verification**: Commit 64df24f - Confirmed that Thor help command breaks test-unit registration:
- Mixed device_test with main tests (removed delete_if)
- Enabled help test (removed omit)
- **Result**: Only 65/197 tests registered (132+ tests fail to register)
- **Impact**: Help command cannot be tested alongside main test suite
- **Current solution**: Keep device tests isolated via `test:device_internal` task

**Reason for omit**:
- Display-only feature (non-critical)
- `help` command works manually
- No user-facing impact (CI/CD unaffected)

**Next steps if needed**:
- Investigate test-unit + Thor hook interaction
- Consider alternative testing strategy for device commands
- May require refactoring test infrastructure

---

## Completed Infrastructure

- ‚úÖ Executor abstraction (ProductionExecutor, MockExecutor)
- ‚úÖ AST-based template engines (Ruby, YAML, C)
- ‚úÖ Device test framework integration
- ‚úÖ Command name refactoring (pra ‚Üí picotorokko)
- ‚úÖ Rake task simplification (CI vs development)
- ‚úÖ Documentation structure cleanup (obsolete docs removed, architecture docs organized)

---

## Planned Features

### üéØ Priority 1: Type System Integration (rbs-inline + Steep)

**Goal**: Add type annotations and static type checking to improve code quality and IDE support

**Strategy**: Use **rbs-inline annotations** (becoming Ruby standard) as primary annotation method. Auto-generate .rbs files. Use Steep for type checking. NO YARD.

**Reference Documentation** (Design & Implementation Guides):
- **Investigation**: [`.claude/docs/rbs-inline-research.md`](https://github.com/picoruby/picotorokko/blob/main/.claude/docs/rbs-inline-research.md) ‚Äî Deep analysis of rbs-inline (Ruby standard candidate)
- **Strategy**: [`.claude/docs/type-system-strategy.md`](https://github.com/picoruby/picotorokko/blob/main/.claude/docs/type-system-strategy.md) ‚Äî Overall type system integration plan (Phases 2-5)
- **Phase 2+**: [`.claude/docs/type-annotation-guide.md`](https://github.com/picoruby/picotorokko/blob/main/.claude/docs/type-annotation-guide.md) ‚Äî Annotation patterns, examples, workflow
- **TDD Workflow**: [`.claude/docs/t-wada-style-tdd-guide.md`](https://github.com/picoruby/picotorokko/blob/main/.claude/docs/t-wada-style-tdd-guide.md) ‚Äî How RBS integrates into t-wada style TDD

**Status**: Phase 2 complete! Full infrastructure + annotations + RBS generation + Steep type checking:
- ‚úÖ Phase 2 Step 1: Environment setup complete
  - Dependencies: rbs ~> 3.4, steep ~> 1.8, rbs-inline ~> 0.11 in gemspec
  - Steepfile with lib and test targets
  - sig/ directory structure with generated/ subdir
  - Rake tasks: `rake rbs:generate`, `rake steep`
- ‚úÖ Phase 2 Step 2: Comprehensive annotations across all commands
  - Added rbs-inline annotations to CLI + all command classes
  - Full annotations for: Device (8 methods), Mrbgems (1), Rubocop (2)
  - env.rb: 25+ key methods fully annotated
- ‚úÖ Phase 2 Step 3: RBS Collection + Type Generation
  - rbs_collection.yaml: 54 external gems (Thor, FileUtils, YAML, Rake, Minitest, etc.)
  - Generated RBS stubs via `bundle exec rbs collection install`
  - 5 compiled .rbs files (309 lines) from source annotations
  - Steep type checking: 0 errors on picotorokko code ‚úì
  - All 183 tests passing, coverage 87.14% maintained

**Deliverables**:
- Type annotations in all source files (CLI, Commands, Env modules)
- Generated .rbs files in sig/generated/picotorokko/
- RBS Collection with 54 gems in sig/rbs_collection/
- Ready for CI: `rake steep` validates types before merge

---

### üìö Priority 2: Gem Documentation Generation

**Goal**: Generate comprehensive documentation from RBS type definitions

**Strategy**: Rely on RubyDoc.info for Phase 2 (zero config). Evaluate rbs-doc/Steep docs for Phase 3 local generation.

**CRITICAL**: Priority 1 decision (rbs-inline only, NO YARD) means documentation comes from auto-generated .rbs files only.

**Reference Documentation** (Design & Implementation):
- **Design**: [`.claude/docs/documentation-generation.md`](https://github.com/picoruby/picotorokko/blob/main/.claude/docs/documentation-generation.md) ‚Äî RBS-only documentation strategy (Phases 1-3)
- **Phase 2 goal**: Commit .rbs files, let RubyDoc.info auto-generate docs on gem publish

**Status**: Phase 1 design complete. Waiting for Priority 1 Phase 2 completion (.rbs files in sig/)

---

### üîÑ Priority 3: Documentation Update Automation

**Goal**: Ensure implementation changes always trigger documentation updates

**Strategy**: Integrate documentation checks into dev workflow (CLAUDE.md + Quality Gates). Escalate to Claude Skill (Phase 2) and CI validation (Phase 4) later.

**Reference Documentation** (Design & Implementation):
- **Design**: [`.claude/docs/documentation-automation-design.md`](https://github.com/picoruby/picotorokko/blob/main/.claude/docs/documentation-automation-design.md) ‚Äî File change ‚Üí doc mapping (Phases 1-4)
- **Phase 1 (COMPLETE)**: Documentation Check added to CLAUDE.md ("Before every commit" + "Quality Gates")
  - File change mapping: lib/picotorokko/commands/ ‚Üí SPEC.md + README.md, etc.
  - Reference: `.claude/docs/documentation-automation-design.md` for full mapping

**Status**: Phase 1 complete (CLAUDE.md integration). Phases 2-4 pending (Skill, Hook, CI validation)

---

## ‚úÖ Critical Priority: ptrk init Command Implementation

**Background**: New users cannot start projects without initialization command. Manual setup requires 10+ steps and is prone to errors. SPEC.md defines directory structure but no command exists to create it. Template engine is fully implemented and ready to use.

**Goal**: Implement `ptrk init` command to initialize complete PicoRuby project structure with single command.

### ‚úÖ Phase 1: Minimum Implementation (COMPLETE)

- ‚úÖ Create `lib/picotorokko/commands/init.rb`
- ‚úÖ Register `init` subcommand in `lib/picotorokko/cli.rb`
- ‚úÖ Implement basic directory creation (storage/home, patch/{R2P2-ESP32,picoruby-esp32,picoruby}, ptrk_env/)
- ‚úÖ Generate `.gitignore` file (exclude .cache/, build/, ptrk_env/*/)
- ‚úÖ Generate `ptrk_env/.picoruby-env.yml` (empty environment definition template)
- ‚úÖ Add comprehensive tests in `test/commands/init_test.rb`
- ‚úÖ RuboCop clean, coverage 88.69% (exceeds 85%/60% requirement)
- ‚úÖ Commit: 1bd280f - Add complete rbs-inline type annotations

### ‚úÖ Phase 2: Template Expansion (COMPLETE)

- ‚úÖ Create `lib/picotorokko/templates/project/` directory structure
- ‚úÖ Add project README.md template (with placeholder variables)
- ‚úÖ Add sample application (storage/home/app.rb)
- ‚úÖ Add Gemfile template (with picotorokko dependency)
- ‚úÖ Add CLAUDE.md template (ptrk user context, auto-generated)
- ‚úÖ Test: verify all templates render correctly with variables
- ‚úÖ RuboCop clean, coverage 88.39% (exceeds 85%/60% requirement)
- ‚úÖ All tests passing: 196/196 (100% pass rate)

### ‚úÖ Phase 3: Optional Features (COMPLETE)

- ‚úÖ `--with-ci` option (copy GitHub Actions ESP32 build workflow)
  - ‚úÖ Commit: c20b669 - Add --with-ci option
  - ‚úÖ Tests: 196 passing, workflow copied only when enabled
- ‚úÖ `--with-mrbgem NAME` option (generate mrbgem templates)
  - ‚úÖ Commit: cc054d9 - Add --with-mrbgem option
  - ‚úÖ Support multiple mrbgems
  - ‚úÖ Tests: 199 passing, generate single and multiple mrbgems
- ‚úÖ `--author "Name"` option (get from git config user.name)
  - ‚úÖ Already implemented in prepare_variables method
- ‚úÖ `--path PATH` option (create project in specified directory)
  - ‚úÖ Already implemented in determine_project_root method
- ‚úÖ RuboCop clean, coverage 88.69% (exceeds 85%/60% requirement)

**Current Status**:
- Tests: 199 tests passing, 100% pass rate
- Coverage: 88.69% line, 66.67% branch
- RuboCop: 0 violations
- All 3 commits on branch

### ‚úÖ Phase 4: Documentation (COMPLETE)

- ‚úÖ Update README.md "Quick Start" section (start with `ptrk init` command)
  - ‚úÖ Commit: f2e407d - Updated Quick Start with ptrk init steps
  - ‚úÖ Added option flags documentation (--author, --path, --with-ci, --with-mrbgem)
  - ‚úÖ Updated development status (199 tests, 88.69% coverage)
  - ‚úÖ Added Project Initialization section to Commands Reference
- ‚úÖ Update SPEC.md with `ptrk init` command reference and full specification
  - ‚úÖ Comprehensive `ptrk init` command documentation (103 lines)
  - ‚úÖ Directory structure documentation with tree view
  - ‚úÖ Detailed examples for all option combinations
  - ‚úÖ Operation steps explained step-by-step
- ‚úÖ Update docs/CI_CD_GUIDE.md (mention `--with-ci` option)
  - ‚úÖ Commit: baa2e10 - Added Option A: ptrk init --with-ci (recommended)
  - ‚úÖ Option B for manual workflow copy (for existing projects)
  - ‚úÖ Clarified recommended approach for new projects
- ‚úÖ Create docs/PROJECT_INITIALIZATION_GUIDE.md (detailed user guide)
  - ‚úÖ Commit: 43d2335 - Comprehensive 386-line user guide
  - ‚úÖ Quick start examples with command variations
  - ‚úÖ Detailed option explanations with use cases
  - ‚úÖ Project structure walkthrough with descriptions
  - ‚úÖ Troubleshooting section with 5+ solutions
  - ‚úÖ Next steps guide after initialization
  - ‚úÖ Links to related documentation

**Documentation Summary** (Phase 4):
- 7 commits total (code + docs)
- 199 tests passing, 100% pass rate
- 88.69% line coverage, 66.67% branch coverage
- RuboCop: 0 violations
- All documentation in English, consistent style

### Phase 5: User Testing (IN PROGRESS - 2025-11-13)

#### ‚úÖ Completed Tests

- ‚úÖ Test ptrk init in playground/ (project with all options)
  - Tested: `ptrk init test-project --with-ci`
  - Tested: `ptrk init test-mrbgem --with-mrbgem MyGem`
  - **Result**: Basic directory structure generated correctly ‚úì
- ‚úÖ Verify all generated files are correct and functional
  - ‚úÖ storage/home/app.rb (sample application)
  - ‚úÖ Gemfile (dependencies)
  - ‚úÖ README.md (detailed 157-line user guide)
  - ‚úÖ .picoruby-env.yml (environment config)
  - ‚úÖ .gitignore (correct exclusions)

#### ‚ùå Discovered Issues (Infrastructure Blockers) ‚Äî NOW FIXED

- ‚úÖ [TODO-INFRASTRUCTURE-CI-WORKFLOWS] CI workflow YML not generated (FIXED: commit 4b5e696)
  - **Root cause**: Thor option key format handling
  - **Fix**: Check multiple key formats in ProjectInitializer#copy_template_files
  - **Verification status**: Pending re-test in playground/

- ‚úÖ [TODO-INFRASTRUCTURE-MRBGEM-GENERATION] --with-mrbgem flag not processed (FIXED: commit 4b5e696)
  - **Root cause**: Thor option key format handling
  - **Fix**: Check multiple key formats in ProjectInitializer#generate_mrbgems
  - **Verification status**: Pending re-test in playground/

#### üìù Phase 5 Next Steps (Infrastructure Fixes Implemented)

1. **Priority 1 - DONE**: Fixed [TODO-INFRASTRUCTURE-CI-WORKFLOWS] and [TODO-INFRASTRUCTURE-MRBGEM-GENERATION]
2. **Priority 2 - IN PROGRESS**: Re-test ptrk init with fixed implementations in playground/
   - Test: `ptrk init test-project --with-ci` (verify workflow YML created)
   - Test: `ptrk init test-project --with-mrbgem MyGem` (verify mrbgems directory created)
   - Test: Combined flags `ptrk init test-project --with-ci --with-mrbgem MyGem`
   - Test: GitHub Actions workflow CI/CD execution
   - Test: mrbgem compilation and functionality
3. **Priority 3**: Create user FAQ and experience improvements doc

**Success Criteria** (Phase 5 completion):
- ‚úÖ New users can create complete projects with `ptrk init` command ‚úÖ
- ‚úÖ Manual setup steps reduced from 10+ to 0 ‚úÖ
- ‚úÖ All generated files follow project conventions ‚úÖ
- ‚úÖ Tests cover all code paths (‚â•85% line coverage) ‚úÖ
- ‚ùå CI workflow auto-generation works (blocked, to be fixed Phase 5)
- ‚ùå mrbgem auto-generation works (blocked, to be fixed Phase 5)

---

## Quality Gates

All features must meet these criteria before merging:

### Pre-Commit Checks (Local Development)

- ‚úÖ All tests passing (197+ tests): `bundle exec rake test`
- ‚úÖ RuboCop: 0 violations: `bundle exec rubocop`
- ‚úÖ Coverage: ‚â•85% line, ‚â•60% branch: `bundle exec rake ci`
- ‚úÖ **Documentation updated** (Priority 3 Phase 1): If code changed, related docs reviewed and updated in same commit. See `.claude/docs/documentation-structure.md` for file mapping.
- ‚úÖ **rbs-inline annotations added** (Priority 1+): Inline annotations for all new/modified public methods
- ‚úÖ **RBS files generated** (Priority 1+): `rake rbs:generate` creates/updates .rbs files in sig/
- ‚úÖ **Steep check passing** (Priority 1+): `steep check` returns no errors on generated .rbs

### Pre-Push Checks (Final Verification)

- ‚úÖ Documentation updated (SPEC.md, README.md, relevant guides)
- ‚úÖ YARD comments added for public methods (Priority 2+)
- ‚úÖ Architecture docs updated if design changed (docs/architecture/)
- ‚úÖ TODO.md updated (completed tasks removed, new issues added)

### Commit Message Quality

- ‚úÖ Imperative mood ("Add feature" not "Added feature")
- ‚úÖ Concise first line (<50 chars)
- ‚úÖ Detailed body if needed (wrap at 72 chars)
- ‚úÖ References related issues/PRs if applicable
