# PicoRuby Development Guide for {{PROJECT_NAME}}

**Auto-generated by `ptrk init` on {{CREATED_AT}}**

This file contains development conventions and setup instructions for PicoRuby application developers using the `picotorokko` build system.

## Project Setup

**Project Name**: {{PROJECT_NAME}}
**Author**: {{AUTHOR}}
**Created**: {{CREATED_AT}}

## Development Workflow

### 1. Environment Management

All PicoRuby versions are managed through `.picoruby-env.yml` and controlled via `ptrk env` commands:

```bash
# Create a new environment
ptrk env set main --commit abc1234

# View current environment
ptrk env show main

# List all environments
ptrk env list

# Switch environments
ptrk env set development
```

### 2. Building and Testing

Always work in the `build/` directory for compilation:

```bash
# Setup build environment (creates build/current/ symlink)
ptrk build setup

# Build (in R2P2-ESP32 directory)
cd build/current/R2P2-ESP32
rake build
cd ../../..

# Or use delegation (if available in future ptrk versions)
ptrk device build
```

### 3. Application Code Organization

Your application code goes in `storage/home/`:

```
storage/home/
├── main.rb        # Entry point (auto-included by R2P2-ESP32)
├── lib/           # Application libraries (optional)
│   └── my_module.rb
└── ...
```

### 4. Making Changes and Patching

To customize R2P2-ESP32 or dependencies:

1. **Edit in `build/current/R2P2-ESP32/`**
2. **Export as patches**:
   ```bash
   ptrk patch export
   ```
3. **Commit to git**:
   ```bash
   git add patch/ storage/home/
   git commit -m "Update application and patches"
   ```
4. **Apply to other environments**:
   ```bash
   ptrk env set development
   ptrk build setup  # patches auto-applied
   ```

## Directory Structure

```
<project-root>/
├── storage/home/           # Your application code (git-managed)
├── patch/                  # Customizations (git-managed)
│   ├── R2P2-ESP32/
│   ├── picoruby-esp32/
│   └── picoruby/
│
├── .cache/                 # Repository snapshots (git-ignored)
├── build/                  # Build working directory (git-ignored)
├── ptrk_env/               # Environment metadata (git-ignored)
│
├── .picoruby-env.yml       # Environment definitions
├── .gitignore
├── Gemfile
├── README.md
└── CLAUDE.md               # This file
```

## Useful Commands

### Environment Inspection

```bash
ptrk env show main          # Show environment configuration
ptrk env list               # List all environments
```

### Build Management

```bash
ptrk build setup main       # Setup build environment
ptrk build list             # List available builds
ptrk build clean            # Clean current build
```

### Cache Management

```bash
ptrk cache list             # List cached versions
ptrk cache fetch latest     # Fetch latest versions
ptrk cache prune            # Remove unused caches
```

### Patch Management

```bash
ptrk patch export           # Export changes to patches/
ptrk patch apply            # Apply patches to build/
ptrk patch diff             # Show changes vs patches
```

## Tips and Best Practices

### Cache Efficiency

- **Reuse versions**: Multiple environments can share cache entries
- **Clean up**: Run `ptrk cache prune` to free disk space
- **Immutable cache**: Caches are never modified; always create new ones for changes

### Patch Management

- **Export frequently**: Use `ptrk patch export` after changes to ensure patches are saved
- **Test patches**: Switch environments to verify patches apply correctly to different versions
- **Keep patches simple**: Smaller patches are easier to understand and maintain

### Build Performance

- **Reuse build directories**: Use `ptrk env set` to switch instead of `ptrk build clean` + setup
- **Monitor disk**: Build directories can be large; monitor `.cache/` and `build/` sizes

## Troubleshooting

### Build Environment Missing

```bash
# List available builds
ptrk build list

# If missing, setup the environment
ptrk build setup main
```

### Patches Not Applied

```bash
# Check patch differences
ptrk patch diff

# Re-setup build (patches auto-applied)
ptrk build clean
ptrk build setup
```

### Cache Issues

```bash
# Check cache
ptrk cache list

# Clean and re-fetch if needed
ptrk cache clean R2P2-ESP32
ptrk cache fetch latest
```

## Further Documentation

- **`README.md`** — Project overview and quick start
- **`SPEC.md`** — Complete ptrk command specification (in picotorokko gem)
- **`https://github.com/picoruby/picotorokko`** — picotorokko gem repository and documentation
- **`https://github.com/picoruby/R2P2-ESP32`** — R2P2-ESP32 repository
- **`https://github.com/picoruby/picoruby`** — PicoRuby language repository

## Environment Variables

When running commands in `build/current/R2P2-ESP32/`, the following environment is important:

- **ESP-IDF setup** — Automatically handled by R2P2-ESP32's Rakefile
- **Git submodules** — Already cloned and configured by ptrk
- **Build cache** — Reused within same build environment (build/ directory)

No manual environment setup is required when using `ptrk` commands.

## Development Tips

1. **Small commits**: Keep commits focused on single changes (application OR patches, not both)
2. **Test regularly**: After `ptrk env set`, verify with `ptrk env show` before building
3. **Document patches**: Add notes in `patch/README.md` explaining why custom patches exist
4. **Version management**: Use descriptive environment names like `stable`, `testing`, `development`

---

**Generated by picotorokko v{{PICOTOROKKO_VERSION}} — https://github.com/picoruby/picotorokko**
