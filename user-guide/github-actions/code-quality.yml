# Code Quality Workflow Template for PicoRuby Applications
#
# **TARGET AUDIENCE**: PicoRuby application developers
#
# This workflow performs code quality checks including:
# - Linting with RuboCop
# - Type checking with Steep
# - Code style validation
#
# **Users**: Enable for Ruby code in your project.
# **gem developers**: Do NOT modify this template without coordination.
#
# Prerequisites:
# 1. RuboCop configured (see .rubocop.yml generated by `ptrk init`)
# 2. (Optional) Steep for type checking
# 3. Ruby code in `lib/`, `test/`, or project root

name: Code Quality

on:
  push:
    branches:
      - main
      - develop
  pull_request:
  workflow_dispatch:

jobs:
  rubocop:
    runs-on: ubuntu-latest
    name: RuboCop Linting

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Run RuboCop
        run: bundle exec rubocop --parallel --display-cop-names

      - name: Generate RuboCop report
        if: always()
        run: |
          echo "# RuboCop Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Code style check completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To fix violations automatically:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "bundle exec rubocop --autocorrect" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Comment RuboCop violations on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ RuboCop violations found. Please run `bundle exec rubocop --autocorrect` locally.'
            })

  steep:
    runs-on: ubuntu-latest
    name: Steep Type Checking
    continue-on-error: true  # Type checking is optional

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Check if Steep is available
        id: check-steep
        run: bundle list steep > /dev/null 2>&1 && echo "available=true" || echo "available=false"

      - name: Run Steep type checking
        if: steps.check-steep.outputs.available == 'true'
        run: bundle exec steep check 2>&1 || echo "Type checking completed with issues"

      - name: Skipped Steep (not in Gemfile)
        if: steps.check-steep.outputs.available != 'true'
        run: echo "ℹ️ Steep not configured. Add to Gemfile to enable type checking."

  style-validation:
    runs-on: ubuntu-latest
    name: Style Validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'

      - name: Check for common style issues
        run: |
          echo "# Style Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for trailing whitespace
          if grep -r '[[:space:]]$' --include="*.rb" lib test; then
            echo "⚠️ Trailing whitespace found" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ No trailing whitespace" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for TODO/FIXME comments (informational)
          count=$(grep -r "TODO\|FIXME" --include="*.rb" lib test 2>/dev/null | wc -l)
          if [ $count -gt 0 ]; then
            echo "ℹ️ Found $count TODO/FIXME comments" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate quality report
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Run tests locally: \`bundle exec rake test\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix style issues: \`bundle exec rubocop --autocorrect\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check types: \`bundle exec steep check\`" >> $GITHUB_STEP_SUMMARY

  summary:
    runs-on: ubuntu-latest
    needs: [rubocop, steep, style-validation]
    if: always()

    steps:
      - name: Quality Check Summary
        run: |
          echo "# Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.rubocop.result }}" == "success" ]; then
            echo "✅ RuboCop passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ RuboCop failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.style-validation.result }}" == "success" ]; then
            echo "✅ Style validation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Style validation failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "✓ Type checking (optional)" >> $GITHUB_STEP_SUMMARY
