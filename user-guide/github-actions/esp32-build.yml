# ESP32 Firmware Build Workflow Template for PicoRuby Applications
#
# **TARGET AUDIENCE**: PicoRuby application developers
#
# This workflow is a TEMPLATE for PicoRuby application developers to automate
# ESP32 firmware builds using the ptrk gem.
#
# **Users**: Customize environment names, ESP-IDF versions, and build targets for your project.
# **gem developers**: Do NOT modify this template without coordination.
#
# This workflow builds ESP32 firmware for PicoRuby applications using the ptrk tool.
# Copy this file to .github/workflows/esp32-build.yml in your project.
#
# Prerequisites:
# 1. Install ptrk gem in your project (bundle add picotorokko)
# 2. Create .ptrk_env/.picoruby-env.yml with your R2P2-ESP32 configuration
# 3. (Optional) Configure CODECOV_TOKEN for coverage reports

name: ESP32 Firmware Build

on:
  push:
    branches:
      - main
      - develop
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Install picotorokko gem
        run: |
          gem install picotorokko
          ptrk --version

      - name: Setup ESP-IDF environment
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: v5.1
          target: esp32

      - name: Prepare build environment
        run: |
          # Set up PicoRuby environment (creates .ptrk_env directory)
          ptrk env set production

      - name: Build firmware
        run: |
          ptrk device build

      - name: List build artifacts
        run: |
          find .ptrk_build/production/R2P2-ESP32/build -name "*.bin" -o -name "*.elf" 2>/dev/null || echo "Build artifacts may not be available"

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esp32-firmware
          path: |
            .ptrk_build/production/R2P2-ESP32/build/bootloader/bootloader.bin
            .ptrk_build/production/R2P2-ESP32/build/partition_table/partition-table.bin
            .ptrk_build/production/R2P2-ESP32/build/*.bin
            .ptrk_build/production/R2P2-ESP32/build/*.elf
          retention-days: 30
          if-no-files-found: warn

      - name: Generate flash instructions
        if: success()
        run: |
          echo "# Flash Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifacts and flash to your ESP32 using:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ptrk device flash --port /dev/ttyUSB0" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Or use esptool.py directly:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash \\" >> $GITHUB_STEP_SUMMARY
          echo "  0x1000 bootloader.bin \\" >> $GITHUB_STEP_SUMMARY
          echo "  0x8000 partition-table.bin \\" >> $GITHUB_STEP_SUMMARY
          echo "  0x10000 <your-app-name>.bin" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Optional: Run Ruby tests if you have PicoRuby unit tests
  # Enable this job by changing 'if: false' to 'if: true'
  test:
    runs-on: ubuntu-latest
    if: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Run tests
        run: bundle exec rake test

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: success()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
        continue-on-error: true
